<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>念经圆满 · 祝贺动画 · 双音效</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html, body { width:100%; height:100%; overflow:hidden; background:#f5f1e6; font-family:'Noto Serif SC',serif; }
        body { 
            background-image:url('lianchi.jpg'); 
            background-size:cover; 
            background-position:center; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            position: relative;
        }
        .container {
            width:100%; max-width:1000px; height:100%; max-height:100%;
            background:rgba(255,253,248,0.97); border-radius:28px; border:1px solid #e0d5bd;
            display:flex; flex-direction:column; overflow-y:auto; -webkit-overflow-scrolling:touch;
            padding:max(16px, env(safe-area-inset-top)) max(16px, env(safe-area-inset-right)) max(12px, env(safe-area-inset-bottom)) max(16px, env(safe-area-inset-left));
            margin:0 auto; box-shadow:0 8px 30px rgba(0,0,0,0.15);
            position: relative;
            z-index: 2;
        }
        /* 头部布局：左侧方形logo，中间标题，右侧链接 */
        header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border-bottom:1px solid #e0d5bd; 
            padding-bottom:10px; 
            margin-bottom:6px; 
            flex-shrink:0;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 60px; /* 为logo占位 */
        }
        .logo-img {
            width: 40px;
            height: 40px;
            object-fit: cover;      /* 保持比例裁剪，确保填满方形 */
            border: 2px solid #d4af37;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            border-radius: 0;        /* 明确方形，无圆角 */
        }
        .header-title {
            text-align: center;
            flex: 1;
        }
        .header-title h1 { 
            font-size:2.0rem; 
            color:#7b3f00; 
            margin:0 5px 4px; 
            line-height:1.3; 
            white-space: nowrap;
        }
        .header-title .subtitle { 
            color:#8b5a2b; 
            font-style:italic;
            font-size: 0.95rem;
        }
        .header-right {
            min-width: 60px;
            text-align: right;
        }
        .more-link {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: #f4ecde;
            border: 1px solid #c9b58b;
            border-radius: 40px;
            padding: 8px 16px;
            font-size: 1rem;
            color: #5d3e20;
            text-decoration: none;
            white-space: nowrap;
            transition: background 0.2s;
        }
        .more-link:hover {
            background: #e1d2b7;
        }
        .more-link i {
            font-size: 0.9rem;
        }

        .reading-area {
            flex:1; background:#fffcf5; border-radius:24px; padding:20px; border:1px solid #e0d5bd;
            display:flex; flex-direction:column; min-height:280px; margin-bottom:8px;
        }
        .sutra-title { font-size:1.8rem; color:#7b3f00; text-align:center; border-bottom:1px dashed #d4b68a; padding-bottom:10px; margin-bottom:14px; flex-shrink:0; }
        .sutra-text {
            font-size:1.3rem; line-height:2.2; color:#2b1e12; text-align:justify;
            overflow-y:auto; -webkit-overflow-scrolling:touch; padding:8px 12px;
            flex:1; background:#fffdf9; border-radius:16px; border:1px solid #eee3d0;
            cursor:pointer; user-select:none;
            white-space:pre-wrap; word-break:break-word;
        }
        .sutra-text::-webkit-scrollbar { width:5px; }
        .sutra-text::-webkit-scrollbar-track { background:#f0e4d2; }
        .sutra-text::-webkit-scrollbar-thumb { background:#b5946e; border-radius:8px; }
        .sutra-text .current-char { background-color:#f3d9a4; border-radius:4px; box-shadow:0 0 0 1px #c9a062; display:inline; }
        .sutra-text .read-char { color:#a39280; }
        .sutra-text .skipped-content { color:#c0b0a0; }
        .progress-section { display:flex; align-items:center; gap:12px; margin-top:14px; flex-shrink:0; }
        .progress-info { color:#6b4f2e; white-space:nowrap; }
        .progress-bar-container { flex:1; height:8px; background:#e5d9c0; border-radius:12px; overflow:hidden; }
        .progress-fill { height:100%; background:#8b5a2b; width:0%; transition:width 0.2s; }
        .reading-tools {
            display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
            gap:12px; margin-top:6px; flex-shrink:0; padding:5px 0;
        }
        .left-tools { display:flex; flex-wrap:wrap; gap:12px; }
        .right-tools { display:flex; flex-wrap:wrap; gap:12px; justify-content:flex-end; }
        .tool-btn {
            background:#f4ecde; border:1px solid #c9b58b; color:#5d3e20;
            padding:8px 20px; border-radius:40px; font-size:1rem; min-height:44px;
            cursor:pointer; display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
        }
        .tool-btn:active { background:#e1d2b7; transform:scale(0.97); }
        .btn-primary { background:#8b5a2b; color:white; border:none; }
        .btn-outline { background:#f4ecde; color:#5d3e20; border:1px solid #c9b58b; }
        .file-input-wrapper { position:relative; overflow:hidden; display:inline-block; }
        .file-input-wrapper input[type=file] { position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer; }
        
        /* 木鱼按钮样式 (与mute-btn一致，顺序在静音右侧) */
        .woodfish-btn {
            background:#f4ecde; color:#5d3e20; border:1px solid #c9b58b;
            padding:8px 18px; border-radius:40px; font-size:0.95rem;
            display:inline-flex; align-items:center; gap:6px; cursor:pointer; min-height:44px;
        }
        .woodfish-btn:active { background:#e1d2b7; transform:scale(0.97); }
        .woodfish-btn i { font-size:1.1rem; color:#7b3f00; }

        .mute-btn {
            background:#f4ecde; color:#5d3e20; border:1px solid #c9b58b;
            padding:8px 18px; border-radius:40px; font-size:0.95rem;
            display:inline-flex; align-items:center; gap:6px; cursor:pointer; min-height:44px;
        }
        .mute-btn.muted { background:#d4b483; color:#3a2a1a; }
        .mute-btn i { font-size:1.1rem; }
        
        /* 祝贺动画浮层 */
        .congrats-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .congrats-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .congrats-card {
            background: linear-gradient(145deg, #fff3d6, #ffe4b5);
            border: 3px solid #d4af37;
            border-radius: 60px 60px 40px 40px;
            padding: 40px 60px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 0 8px rgba(255,215,0,0.3);
            text-align: center;
            transform: scale(0.8) translateY(30px);
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90%;
        }
        .congrats-overlay.show .congrats-card {
            transform: scale(1) translateY(0);
        }
        .congrats-text {
            font-size: 3.2rem;
            font-weight: bold;
            color: #7b3f00;
            text-shadow: 2px 2px 0 #ffd966, 4px 4px 0 rgba(180, 120, 30, 0.3);
            margin-bottom: 20px;
            line-height: 1.3;
        }
        .congrats-sub {
            font-size: 2rem;
            color: #b45f1b;
            border-top: 2px dashed #d4af37;
            padding-top: 20px;
            font-style: italic;
        }
        .confetti {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }
        .confetti-particle {
            position: absolute;
            width: 10px;
            height: 20px;
            background: #ffd700;
            opacity: 0.7;
            animation: fall 4s linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotate(720deg); opacity: 0; }
        }
        
        @media (max-width:600px) {
            .congrats-text { font-size: 2.2rem; }
            .congrats-sub { font-size: 1.5rem; }
            .reading-tools { flex-direction:column; align-items:stretch; }
            .left-tools, .right-tools { justify-content:center; }
            .header-title h1 { font-size: 1.6rem; }
            .more-link { padding: 5px 10px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>
    <!-- 主界面 -->
    <div class="container">
        <!-- 头部：左侧方形logo，中间标题，右侧更多链接 -->
        <header>
            <div class="header-left">
                <img src="https://amitofoicu.github.io/home/logo.jpg" alt="logo" class="logo-img" onerror="this.style.display='none'">
            </div>
            <div class="header-title">
                <h1>念经小助手</h1>
                <div class="subtitle">点击/空格逐字跟读 · 圆满贺礼</div>
            </div>
            <div class="header-right">
                <a href="https://amitofoicu.github.io/home/main.html" class="more-link" target="_blank" rel="noopener noreferrer">
                    <i class="fas fa-external-link-alt"></i> 更多
                </a>
            </div>
        </header>

        <div class="reading-area">
            <div class="sutra-title" id="sutraTitle">《般若波罗蜜多心经》</div>
            <div class="sutra-text" id="sutraText" tabindex="0"></div>
            <div class="progress-section">
                <span class="progress-info" id="progressInfo">进度 0%</span>
                <div class="progress-bar-container"><div class="progress-fill" id="progressFill"></div></div>
            </div>
        </div>
        <div class="reading-tools">
            <div class="left-tools">
                <button class="tool-btn" id="fontDown"><i class="fas fa-search-minus"></i> 缩小</button>
                <button class="tool-btn" id="fontUp"><i class="fas fa-search-plus"></i> 放大</button>
                <button class="tool-btn" id="resetIndex"><i class="fas fa-undo-alt"></i> 重头开始</button>
            </div>
            <div class="right-tools">
                <div class="file-input-wrapper">
                    <button class="tool-btn btn-primary" id="fileUploadBtn"><i class="fas fa-file-import"></i> 选择TXT</button>
                    <input type="file" id="fileInput" accept=".txt, text/plain">
                </div>
                <button class="tool-btn btn-outline" id="restoreBtn"><i class="fas fa-history"></i> 恢复默认</button>
                <!-- 先静音按钮，后木鱼按钮（静音右侧） -->
                <button class="mute-btn" id="muteBtn">
                    <i class="fas fa-volume-up"></i> 静音
                </button>
                <button class="woodfish-btn" id="woodfishBtn">
                    <i class="fas fa-drum"></i> 木鱼
                </button>
            </div>
        </div>
    </div>

    <!-- 祝贺动画浮层 -->
    <div class="congrats-overlay" id="congratsOverlay">
        <div class="confetti" id="confettiContainer"></div>
        <div class="congrats-card">
            <div class="congrats-text">诵读圆满</div>
            <div class="congrats-sub">随喜功德</div>
        </div>
    </div>

<script>
(function() {
    // ---------- 默认经文 ----------
    const DEFAULT_TITLE = "般若波罗蜜多心经";
    const DEFAULT_TEXT = `观自在菩萨，行深般若波罗蜜多时，照见五蕴皆空，度一切苦厄。
舍利子，色不异空，空不异色，色即是空，空即是色，受想行识，亦复如是。
舍利子，是诸法空相，不生不灭，不垢不净，不增不减。
是故空中无色，无受想行识，无眼耳鼻舌身意，无色声香味触法，无眼界，乃至无意识界。
无无明，亦无无明尽，乃至无老死，亦无老死尽。
无苦集灭道，无智亦无得，以无所得故。
菩提萨埵，依般若波罗蜜多故，心无罣碍，无罣碍故，无有恐怖，远离颠倒梦想，究竟涅槃。
三世诸佛，依般若波罗蜜多故，得阿耨多罗三藐三菩提。
故知般若波罗蜜多，是大神咒，是大明咒，是无上咒，是无等等咒，能除一切苦，真实不虚。
故说般若波罗蜜多咒，即说咒曰：揭谛揭谛，波罗揭谛，波罗僧揭谛，菩提萨婆诃。`;

    // 音效URL
    const SOUNDS = {
        ENDING: 'https://amitofoicu.github.io/home/ending.mp3',
        XIAOCHU: 'https://amitofoicu.github.io/home/xiaochu.mp3'
    };

    // 状态
    let currentTitle = DEFAULT_TITLE;
    let currentText = DEFAULT_TEXT;
    
    let displayChars = [];
    let charTypes = [];
    let hanziIndices = [];
    let currentHanziIndex = 0;
    let fontSize = 1.3;
    
    let isMuted = false;

    // 预加载的音效对象
    const audioPool = {
        ending: null,
        xiaochu: null,
        initialized: false
    };

    // DOM 元素
    const sutraTitle = document.getElementById('sutraTitle');
    const sutraText = document.getElementById('sutraText');
    const fileInput = document.getElementById('fileInput');
    const restoreBtn = document.getElementById('restoreBtn');
    const muteBtn = document.getElementById('muteBtn');
    const woodfishBtn = document.getElementById('woodfishBtn'); // 木鱼按钮
    const progressInfo = document.getElementById('progressInfo');
    const progressFill = document.getElementById('progressFill');
    const fontDown = document.getElementById('fontDown');
    const fontUp = document.getElementById('fontUp');
    const resetIndexBtn = document.getElementById('resetIndex');
    const fileUploadBtn = document.getElementById('fileUploadBtn');
    const congratsOverlay = document.getElementById('congratsOverlay');
    const confettiContainer = document.getElementById('confettiContainer');

    // ---------- 预加载所有音效 ----------
    async function preloadAllSounds() {
        if (audioPool.initialized) return;
        
        console.log('开始预加载音效...');
        
        const originalBtnText = fileUploadBtn.innerHTML;
        fileUploadBtn.innerHTML = '<i class="fas fa-spinner fa-pulse"></i> 加载音效...';
        fileUploadBtn.disabled = true;
        muteBtn.disabled = true;
        woodfishBtn.disabled = true; // 禁用木鱼
        
        try {
            audioPool.ending = new Audio();
            audioPool.ending.preload = 'auto';
            audioPool.ending.src = SOUNDS.ENDING;
            audioPool.ending.load();
            
            audioPool.xiaochu = new Audio();
            audioPool.xiaochu.preload = 'auto';
            audioPool.xiaochu.src = SOUNDS.XIAOCHU;
            audioPool.xiaochu.load();
            
            await Promise.race([
                Promise.all([
                    new Promise(resolve => { audioPool.ending.addEventListener('canplaythrough', resolve, { once: true }); }),
                    new Promise(resolve => { audioPool.xiaochu.addEventListener('canplaythrough', resolve, { once: true }); })
                ]),
                new Promise(resolve => setTimeout(resolve, 4000))
            ]);
            
            console.log('音效预加载完成');
        } catch (error) {
            console.warn('音效预加载失败:', error);
        } finally {
            fileUploadBtn.innerHTML = originalBtnText;
            fileUploadBtn.disabled = false;
            muteBtn.disabled = false;
            woodfishBtn.disabled = false;
            audioPool.initialized = true;
        }
    }

    // ---------- 播放圆满贺礼：动画 + 双音效 ----------
    function playCompletionCelebration() {
        congratsOverlay.classList.add('show');
        
        for (let i = 0; i < 15; i++) {
            createConfetti();
        }
        
        if (audioPool.ending && audioPool.xiaochu) {
            const endingClone = audioPool.ending.cloneNode();
            const xiaochuClone = audioPool.xiaochu.cloneNode();
            
            Promise.all([
                endingClone.play().catch(e => console.log('ending播放失败:', e)),
                xiaochuClone.play().catch(e => console.log('xiaochu播放失败:', e))
            ]);
        } else {
            new Audio(SOUNDS.ENDING).play().catch(e => {});
            new Audio(SOUNDS.XIAOCHU).play().catch(e => {});
        }
        
        setTimeout(() => {
            congratsOverlay.classList.remove('show');
            while (confettiContainer.firstChild) {
                confettiContainer.removeChild(confettiContainer.firstChild);
            }
        }, 5000);
    }

    function createConfetti() {
        const particle = document.createElement('div');
        particle.className = 'confetti-particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.background = `hsl(${Math.random() * 60 + 30}, 80%, 60%)`;
        particle.style.width = Math.random() * 15 + 5 + 'px';
        particle.style.height = Math.random() * 20 + 10 + 'px';
        particle.style.animationDuration = Math.random() * 3 + 2 + 's';
        particle.style.animationDelay = Math.random() * 2 + 's';
        confettiContainer.appendChild(particle);
        
        setTimeout(() => {
            if (particle.parentNode) particle.remove();
        }, 6000);
    }

    // ---------- 木鱼音效 (Web Audio API) ----------
    let audioContext = null;
    let muyuBuffer = null;
    
    async function preloadMuyuSound() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const sampleRate = audioContext.sampleRate;
            const duration = 0.15;
            const frameCount = sampleRate * duration;
            const buffer = audioContext.createBuffer(1, frameCount, sampleRate);
            const channelData = buffer.getChannelData(0);
            
            for (let i = 0; i < frameCount; i++) {
                const t = i / sampleRate;
                const envelope = Math.exp(-t * 20);
                const sin1 = Math.sin(2 * Math.PI * 380 * t);
                const sin2 = Math.sin(2 * Math.PI * 760 * t) * 0.3;
                channelData[i] = (sin1 + sin2) * envelope * 0.5;
            }
            muyuBuffer = buffer;
        } catch (e) {
            console.warn('木鱼预加载失败');
        }
    }

    function playMuyu() {
        if (isMuted) return;
        
        if (audioContext && muyuBuffer) {
            try {
                if (audioContext.state === 'suspended') audioContext.resume();
                const source = audioContext.createBufferSource();
                source.buffer = muyuBuffer;
                const gainNode = audioContext.createGain();
                gainNode.gain.value = 0.3;
                source.connect(gainNode);
                gainNode.connect(audioContext.destination);
                source.start();
            } catch (e) {
                playMuyuFallback();
            }
        } else {
            playMuyuFallback();
        }
    }
    
    function playMuyuFallback() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') ctx.resume();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.value = 420;
            gain.gain.setValueAtTime(0.2, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.1);
        } catch (e) {}
    }

    // ---------- 判断是否为汉字 ----------
    function isChineseChar(char) {
        const code = char.charCodeAt(0);
        return (code >= 0x4E00 && code <= 0x9FFF) ||
               (code >= 0x3400 && code <= 0x4DBF);
    }

    // ---------- 处理文本：跳过括号及其内容 ----------
    function processText(rawText) {
        const chars = Array.from(rawText);
        displayChars = [];
        charTypes = [];
        hanziIndices = [];
        
        let inBracket = false;
        
        for (let i = 0; i < chars.length; i++) {
            const ch = chars[i];
            
            if (ch === '(' || ch === '（') {
                inBracket = true;
                displayChars.push(ch);
                charTypes.push('skipped');
                continue;
            }
            if (ch === ')' || ch === '）') {
                inBracket = false;
                displayChars.push(ch);
                charTypes.push('skipped');
                continue;
            }
            if (inBracket) {
                displayChars.push(ch);
                charTypes.push('skipped');
                continue;
            }
            
            displayChars.push(ch);
            if (isChineseChar(ch)) {
                charTypes.push('hanzi');
                hanziIndices.push(displayChars.length - 1);
            } else {
                charTypes.push('normal');
            }
        }
        
        if (currentHanziIndex >= hanziIndices.length) {
            currentHanziIndex = hanziIndices.length - 1;
        }
        if (currentHanziIndex < 0) currentHanziIndex = 0;
    }

    // ---------- 渲染经文 ----------
    function renderText() {
        if (!displayChars.length) { sutraText.innerHTML = ''; return; }

        let html = '';
        for (let i = 0; i < displayChars.length; i++) {
            const ch = displayChars[i];
            const type = charTypes[i];
            
            let displayChar = ch;
            if (ch === '<') displayChar = '&lt;';
            else if (ch === '>') displayChar = '&gt;';
            else if (ch === '&') displayChar = '&amp;';
            else if (ch === '\n') displayChar = '<br>';
            
            if (type === 'hanzi') {
                const hanziPos = hanziIndices.indexOf(i);
                if (hanziPos < currentHanziIndex) {
                    html += `<span class="read-char">${displayChar}</span>`;
                } else if (hanziPos === currentHanziIndex) {
                    html += `<span class="current-char">${displayChar}</span>`;
                } else {
                    html += displayChar;
                }
            } else if (type === 'skipped') {
                html += `<span class="skipped-content">${displayChar}</span>`;
            } else {
                if (ch !== '\n') {
                    html += displayChar;
                }
            }
        }

        sutraText.innerHTML = html;

        const cur = sutraText.querySelector('.current-char');
        if (cur) {
            cur.scrollIntoView({ block: 'center', behavior: 'smooth' });
        }

        updateProgress();
    }

    function updateProgress() {
        if (!hanziIndices.length) {
            progressInfo.textContent = '进度 0%';
            progressFill.style.width = '0%';
            return;
        }
        const percent = Math.min(100, Math.round((currentHanziIndex / hanziIndices.length) * 100));
        progressInfo.textContent = `进度 ${percent}%`;
        progressFill.style.width = percent + '%';
    }

    // ---------- 下一字 (核心前进逻辑) ----------
    function nextChar() {
        if (!hanziIndices.length) return;
        if (currentHanziIndex >= hanziIndices.length - 1) return; // 最后一个字时不再前进（但可敲木鱼玩）
        
        playMuyu(); // 敲木鱼音效
        
        currentHanziIndex++;
        renderText();
        
        // 判断是否刚读完最后一个汉字（即当前索引变成了最后一个）
        if (currentHanziIndex === hanziIndices.length - 1) {
            playCompletionCelebration(); // 触发圆满动画+双音效
        }
    }

    function resetIndex() {
        currentHanziIndex = 0;
        renderText();
        congratsOverlay.classList.remove('show');
        while (confettiContainer.firstChild) {
            confettiContainer.removeChild(confettiContainer.firstChild);
        }
    }

    function loadNewText(rawText, title) {
        currentText = rawText;
        currentTitle = title || '经文';
        processText(rawText);
        sutraTitle.innerText = `《${currentTitle}》`;
        currentHanziIndex = 0;
        renderText();
        congratsOverlay.classList.remove('show');
        while (confettiContainer.firstChild) {
            confettiContainer.removeChild(confettiContainer.firstChild);
        }
    }

    function toggleMute() {
        isMuted = !isMuted;
        if (isMuted) {
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i> 取消静音';
            muteBtn.classList.add('muted');
        } else {
            muteBtn.innerHTML = '<i class="fas fa-volume-up"></i> 静音';
            muteBtn.classList.remove('muted');
        }
    }

    // ---------- 事件绑定 ----------
    sutraText.addEventListener('click', nextChar);

    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && document.activeElement?.tagName !== 'INPUT' && document.activeElement?.tagName !== 'BUTTON') {
            e.preventDefault();
            nextChar();
        }
    });

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            let content = ev.target.result;
            if (content.charCodeAt(0) === 0xFEFF) content = content.slice(1);
            const name = file.name.replace(/\.txt$/i, '').replace(/\.text$/i, '') || '导入经文';
            loadNewText(content, name);
        };
        reader.readAsText(file, 'UTF-8');
    });

    restoreBtn.addEventListener('click', () => {
        loadNewText(DEFAULT_TEXT, DEFAULT_TITLE);
        fileInput.value = '';
    });

    muteBtn.addEventListener('click', toggleMute);

    // 木鱼按钮：点击时播放音效并前进一个字（与点击经文/空格行为一致）
    woodfishBtn.addEventListener('click', () => {
        nextChar(); // 直接复用核心前进逻辑
    });

    fontDown.addEventListener('click', () => { 
        fontSize = Math.max(0.8, fontSize - 0.1); 
        sutraText.style.fontSize = fontSize + 'rem';
    });
    fontUp.addEventListener('click', () => { 
        fontSize = Math.min(2.5, fontSize + 0.1); 
        sutraText.style.fontSize = fontSize + 'rem';
    });

    resetIndexBtn.addEventListener('click', resetIndex);

    // ---------- 初始化 ----------
    window.addEventListener('load', () => {
        loadNewText(DEFAULT_TEXT, DEFAULT_TITLE);
        preloadAllSounds();
        preloadMuyuSound();
    });

    // 点击页面激活音频上下文
    document.addEventListener('click', function initAudio() {
        if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume();
        }
    }, { once: true });

})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lotus Snake ¬∑ Ëä±Áì£ÈáçÁΩÆÁâà</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            margin: 0;
            min-height: 100vh;
            background: #0a2f1f;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
            padding: 8px;
            position: relative;
        }
        .game-container {
            max-width: 700px;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(2px);
            border-radius: 32px 32px 24px 24px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
            z-index: 5;
        }
        .title-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px;
            background: rgba(6, 38, 24, 0.8);
            backdrop-filter: blur(8px);
            color: white;
            border-bottom: 2px solid #c9a96b;
            position: relative;
        }
        .title-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
            min-width: 0;
        }
        .logo-square {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            overflow: hidden;
            background: #d6b16e;
            box-shadow: 0 2px 8px rgba(255,215,140,0.4);
            flex-shrink: 0;
        }
        .logo-square img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .game-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem;
            font-weight: 800;
            letter-spacing: 3px;
            text-shadow: 2px 2px 0 #2b5e3b;
            white-space: nowrap;
            color: white;
            pointer-events: none;
        }
        .more-games {
            background: #f5c542;
            color: #1e3c2a;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: bold;
            text-decoration: none;
            box-shadow: 0 4px 0 #9e7126;
            transition: all 0.1s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            border: 1px solid #ffe494;
            white-space: nowrap;
            margin-left: 8px;
            cursor: pointer;
            z-index: 10;
        }
        .more-games:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #9e7126;
        }
        .canvas-wrapper {
            background-image: url('https://amitofoicu.github.io/home/lianchi6.jpg');
            background-size: cover;
            background-position: center;
            border-radius: 24px;
            padding: 0;
            position: relative;
        }
        canvas {
            display: block;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: transparent !important;
            border: 4px solid #c1a062;
            border-radius: 24px;
            box-shadow: inset 0 0 0 1px rgba(255,235,170,0.5), 0 12px 18px -8px black;
            position: relative;
            z-index: 10;
        }
        .control-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 12px 8px;
            padding: 12px 16px 18px 16px;
            background: rgba(20, 50, 30, 0.7);
            backdrop-filter: blur(4px);
            border-top: 2px solid #b6904b;
        }
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex: 2 1 auto;
        }
        .btn {
            background: #ecd89e;
            border: none;
            border-bottom: 4px solid #8f6f3a;
            color: #1f3f28;
            font-size: 1.2rem;
            font-weight: 800;
            padding: 12px 24px;
            min-width: 80px;
            border-radius: 60px;
            box-shadow: 0 5px 0 #5f4a27, 0 6px 12px black;
            cursor: pointer;
            transition: all 0.05s linear;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            letter-spacing: 1px;
            touch-action: manipulation;
            white-space: nowrap;
        }
        @media (max-width: 500px) {
            .btn {
                padding: 10px 16px;
                font-size: 1rem;
                min-width: 65px;
            }
            .game-title {
                font-size: 1.3rem;
            }
            .more-games {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }
        .btn:active {
            transform: translateY(5px);
            border-bottom-width: 1px;
        }
        .btn.muted {
            background: #a0a0a0;
            border-bottom-color: #5a5a5a;
            color: #2d2d2d;
        }
        .sound-btn {
            background: #b8d0c0;
        }
        .score-panel {
            background: #1e3625e0;
            padding: 6px 22px;
            border-radius: 40px;
            color: #fadf9e;
            font-size: 1.5rem;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 2px solid #dbb067;
            box-shadow: inset 0 2px 5px #2b542b;
            backdrop-filter: blur(2px);
            white-space: nowrap;
        }
        .score-number {
            color: white;
            font-size: 2rem;
            min-width: 40px;
            text-align: center;
        }
        .footer-note {
            text-align: center;
            color: #c7b08b;
            font-size: 0.8rem;
            padding: 6px 0 10px 0;
            background: #0d2f1bb3;
            letter-spacing: 0.5px;
        }
        .gameover-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .gameover-card {
            pointer-events: auto;
            background: rgba(30, 40, 20, 0.9);
            backdrop-filter: blur(12px);
            border: 3px solid #f5c542;
            border-radius: 60px 60px 40px 40px;
            padding: 30px 50px;
            text-align: center;
            color: #ffefc0;
            box-shadow: 0 20px 30px black;
            transform: scale(1);
            animation: popIn 0.3s ease;
            z-index: 1010;
        }
        .gameover-card h1 {
            font-size: 3rem;
            margin: 0 0 10px;
            text-shadow: 3px 3px 0 #2b5e3b;
        }
        .final-score {
            font-size: 2.5rem;
            background: #2d4a2d;
            padding: 10px 30px;
            border-radius: 60px;
            margin: 20px 0;
            border: 2px solid gold;
        }
        .restart-btn {
            background: #f5c542;
            border: none;
            font-size: 2rem;
            font-weight: bold;
            padding: 15px 45px;
            border-radius: 50px;
            border-bottom: 6px solid #936f1f;
            color: #1e3c2a;
            cursor: pointer;
            transition: 0.05s linear;
            margin-top: 15px;
            box-shadow: 0 8px 0 #6b4f1a;
        }
        .restart-btn:active {
            transform: translateY(6px);
            border-bottom-width: 2px;
        }
        @keyframes popIn {
            0% { transform: scale(0.6); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        #petalCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 999;
        }
        .preload-images {
            display: none;
        }
        .loading-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: gold;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 10000;
            pointer-events: none;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>
    <!-- Loading status indicator -->
    <div class="loading-status" id="loadingStatus">Loading resources...</div>

    <!-- Preload all images -->
    <div class="preload-images">
        <img src="https://amitofoicu.github.io/home/lotus1.jpg" alt="lotus1">
        <img src="https://amitofoicu.github.io/home/lotus2.jpg" alt="lotus2">
        <img src="https://amitofoicu.github.io/home/lotus3.jpg" alt="lotus3">
        <img src="https://amitofoicu.github.io/home/lotus4.jpg" alt="lotus4">
        <img src="https://amitofoicu.github.io/home/logo.jpg" alt="logo">
        <img src="https://amitofoicu.github.io/home/lianchi6.jpg" alt="background">
    </div>

    <canvas id="petalCanvas"></canvas>

    <div class="game-container">
        <div class="title-bar">
            <div class="title-left">
                <div class="logo-square">
                    <img src="https://amitofoicu.github.io/home/logo.jpg" alt="logo" onerror="this.style.backgroundColor='#d4a859';">
                </div>
            </div>
            <span class="game-title">LOTUS SNAKE</span>
            <a href="#" class="more-games" id="moreGamesBtn" target="_blank" rel="noopener">MORE</a>
        </div>

        <div class="canvas-wrapper">
            <canvas id="gameCanvas" width="600" height="600"></canvas>
        </div>

        <div class="control-bar">
            <div class="btn-group">
                <button class="btn" id="startBtn">‚ñ∂ START</button>
                <button class="btn" id="pauseBtn">‚è∏Ô∏è PAUSE</button>
                <button class="btn sound-btn" id="muteBtn">üîä</button>
            </div>
            <div class="score-panel">
                <span>üå∏</span>
                <span class="score-number" id="scoreDisplay">0</span>
            </div>
        </div>
        <div class="footer-note">
            ‚Üê ‚Üë ‚Üí ‚Üì  SWIPE / ARROWS
        </div>
    </div>

    <script>
        (function() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreSpan = document.getElementById('scoreDisplay');
            const petalCanvas = document.getElementById('petalCanvas');
            const pCtx = petalCanvas.getContext('2d');
            const loadingStatus = document.getElementById('loadingStatus');

            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const muteBtn = document.getElementById('muteBtn');
            const moreGames = document.getElementById('moreGamesBtn');

            const GRID_SIZE = 20;
            const CELL_SIZE = canvas.width / GRID_SIZE;

            // Ê∏∏ÊàèÁä∂ÊÄÅ
            let snake = [
                {x: 10, y: 10},
                {x: 9, y: 10},
                {x: 8, y: 10}
            ];
            
            let foods = [];
            
            const foodImageUrls = [
                'https://amitofoicu.github.io/home/lotus1.jpg',
                'https://amitofoicu.github.io/home/lotus2.jpg',
                'https://amitofoicu.github.io/home/lotus3.jpg',
                'https://amitofoicu.github.io/home/lotus4.jpg'
            ];
            let foodImages = [];
            let imagesLoaded = false;

            // ËµÑÊ∫êËÆ°Êï∞
            let resourcesLoaded = {
                images: 0,
                audio: 0,
                totalImages: 6,
                totalAudio: 3,
            };

            function updateLoadingStatus() {
                const total = resourcesLoaded.totalImages + resourcesLoaded.totalAudio;
                const loaded = resourcesLoaded.images + resourcesLoaded.audio;
                if (loaded >= total) {
                    loadingStatus.textContent = '‚úÖ All resources loaded';
                    loadingStatus.style.backgroundColor = 'rgba(0,100,0,0.8)';
                    setTimeout(() => {
                        loadingStatus.style.opacity = '0';
                        setTimeout(() => {
                            loadingStatus.style.display = 'none';
                        }, 500);
                    }, 1500);
                } else {
                    loadingStatus.textContent = `Loading resources... ${loaded}/${total}`;
                }
            }

            // È¢ÑÂä†ËΩΩÂõæÁâá
            function preloadAllImages() {
                return new Promise((resolve) => {
                    const allImages = [
                        'https://amitofoicu.github.io/home/lotus1.jpg',
                        'https://amitofoicu.github.io/home/lotus2.jpg',
                        'https://amitofoicu.github.io/home/lotus3.jpg',
                        'https://amitofoicu.github.io/home/lotus4.jpg',
                        'https://amitofoicu.github.io/home/logo.jpg',
                        'https://amitofoicu.github.io/home/lianchi6.jpg'
                    ];
                    
                    let loadedCount = 0;
                    
                    allImages.forEach((url, idx) => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        
                        img.onload = () => {
                            loadedCount++;
                            resourcesLoaded.images = loadedCount;
                            
                            if (idx < 4) {
                                foodImages[idx] = img;
                            }
                            
                            updateLoadingStatus();
                            
                            if (loadedCount === allImages.length) {
                                imagesLoaded = true;
                                resolve();
                            }
                        };
                        
                        img.onerror = () => {
                            console.warn('Image loading failed', url);
                            loadedCount++;
                            resourcesLoaded.images = loadedCount;
                            
                            if (idx < 4) {
                                // Â§áÁî®Ëâ≤Âùó
                                const canvas = document.createElement('canvas');
                                canvas.width = 100;
                                canvas.height = 100;
                                const ctx = canvas.getContext('2d');
                                ctx.fillStyle = ['#ff4d4d', '#ffaa33', '#ff66b2', '#aa66ff'][idx % 4];
                                ctx.beginPath();
                                ctx.arc(50, 50, 40, 0, 2*Math.PI);
                                ctx.fill();
                                const fallbackImg = new Image();
                                fallbackImg.src = canvas.toDataURL();
                                foodImages[idx] = fallbackImg;
                            }
                            
                            updateLoadingStatus();
                            
                            if (loadedCount === allImages.length) {
                                imagesLoaded = true;
                                resolve();
                            }
                        };
                        
                        img.src = url;
                    });
                });
            }

            // ÈöèÊú∫È£üÁâ©Êï∞Èáè 1-5
            function randomFoodN() {
                return Math.floor(Math.random() * 5) + 1;
            }

            // ÈöèÊú∫ÂõæÁâáÁ¥¢Âºï
            function randomFoodImageIndex() {
                return Math.floor(Math.random() * 4);
            }

            // ÁîüÊàêÊñ∞È£üÁâ©
            function generateFoods() {
                const snakeSet = new Set(snake.map(cell => `${cell.x},${cell.y}`));
                let free = [];
                for (let i = 0; i < GRID_SIZE; i++) {
                    for (let j = 0; j < GRID_SIZE; j++) {
                        if (!snakeSet.has(`${i},${j}`)) free.push({x: i, y: j});
                    }
                }
                
                if (free.length === 0) return false;
                
                const N = Math.min(randomFoodN(), free.length);
                
                const newFoods = [];
                const shuffled = [...free];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                for (let i = 0; i < N; i++) {
                    newFoods.push({
                        x: shuffled[i].x,
                        y: shuffled[i].y,
                        imageIndex: randomFoodImageIndex()
                    });
                }
                
                foods = newFoods;
                return true;
            }

            let direction = 'RIGHT';
            let nextDirection = 'RIGHT';
            let score = 0;
            let gameRunning = false;
            let gamePaused = false;
            let gameInterval = null;
            const gameSpeed = 200;

            // ÂëºÂê∏ÂÖâÊïà
            let glowPhase = 0;
            const glowSpeed = 0.02;

            // Èü≥È¢ë
            let audioCtx = null;
            let bgmBuffer = null;
            let winBuffer = null;
            let xiaochuBuffer = null;
            let bgmSource = null;
            let muted = false;
            let audioUnlocked = false;

            try {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            } catch (e) { console.warn("Web Audio not supported"); }

            // È¢ÑÂä†ËΩΩÈü≥È¢ë
            async function preloadAllAudio() {
                if (!audioCtx) { 
                    resourcesLoaded.audio = 3;
                    updateLoadingStatus();
                    return; 
                }
                
                try {
                    const [bgmData, winData, xcData] = await Promise.all([
                        fetch('https://amitofoicu.github.io/home/beijing.ogg').then(r => r.arrayBuffer()),
                        fetch('https://amitofoicu.github.io/home/win.mp3').then(r => r.arrayBuffer()),
                        fetch('https://amitofoicu.github.io/home/xiaochu.mp3').then(r => r.arrayBuffer())
                    ]);
                    
                    const [bgm, win, xc] = await Promise.all([
                        audioCtx.decodeAudioData(bgmData),
                        audioCtx.decodeAudioData(winData),
                        audioCtx.decodeAudioData(xcData)
                    ]);
                    
                    bgmBuffer = bgm;
                    winBuffer = win;
                    xiaochuBuffer = xc;
                    
                    resourcesLoaded.audio = 3;
                    updateLoadingStatus();
                } catch (err) {
                    resourcesLoaded.audio = 3;
                    updateLoadingStatus();
                }
            }

            Promise.all([preloadAllImages(), preloadAllAudio()]).then(() => {
                console.log('All resources loaded');
            });

            function unlockAudioForIOS() {
                if (!audioCtx || audioUnlocked) return Promise.resolve();
                audioUnlocked = true;
                return audioCtx.resume().then(() => {
                    const silentBuffer = audioCtx.createBuffer(1, 1, 22050);
                    const src = audioCtx.createBufferSource();
                    src.buffer = silentBuffer;
                    src.connect(audioCtx.destination);
                    src.start();
                }).catch(e => console.warn('unlock failed', e));
            }

            function playBGM() {
                if (muted || !audioCtx || !bgmBuffer) return;
                if (bgmSource) {
                    try { bgmSource.stop(); } catch(e) {}
                    bgmSource = null;
                }
                bgmSource = audioCtx.createBufferSource();
                bgmSource.buffer = bgmBuffer;
                bgmSource.loop = true;
                bgmSource.connect(audioCtx.destination);
                bgmSource.start();
            }

            function stopBGM() {
                if (bgmSource) {
                    try { bgmSource.stop(); } catch(e) {}
                    bgmSource = null;
                }
            }

            function playWin() {
                if (muted || !audioCtx || !winBuffer) return;
                const src = audioCtx.createBufferSource();
                src.buffer = winBuffer;
                src.connect(audioCtx.destination);
                src.start();
            }

            function playXiaochu() {
                if (muted || !audioCtx || !xiaochuBuffer) return;
                const src = audioCtx.createBufferSource();
                src.buffer = xiaochuBuffer;
                src.connect(audioCtx.destination);
                src.start();
            }

            function toggleMute() {
                muted = !muted;
                if (muted) {
                    muteBtn.innerHTML = 'üîá';
                    muteBtn.classList.add('muted');
                    stopBGM();
                } else {
                    muteBtn.innerHTML = 'üîä';
                    muteBtn.classList.remove('muted');
                    if (gameRunning && !gamePaused) playBGM();
                }
            }

            // Ëä±Áì£Âä®ÁîªÁ≥ªÁªü
            let petals = [];
            let petalAnimation = null;
            let petalAnimationRunning = false;

            // Ê∏ÖÈô§ÊâÄÊúâËä±Áì£ÔºàÈáçÁΩÆÁî®Ôºâ
            function clearAllPetals() {
                petals = [];            // Ê∏ÖÁ©∫Êï∞ÁªÑ
                pCtx.clearRect(0, 0, petalCanvas.width, petalCanvas.height); // Á´ãÂç≥Ê∏ÖÈô§ÁîªÂ∏É
            }

            // ÁîüÊàê‰∏§ÊúµÁªΩÊîæËä±Áì£ÔºàÂêÉÈ£üÁâ©Êó∂Ôºâ
            function spawnTwoBlossomsAt(x, y) {
                console.log('Spawning blossoms at:', x, y); // Ë∞ÉËØïÁî®
                const canvasRect = canvas.getBoundingClientRect();
                const screenX = canvasRect.left + (x / canvas.width) * canvasRect.width;
                const screenY = canvasRect.top + (y / canvas.height) * canvasRect.height;

                for (let i = 0; i < 2; i++) {
                    const angle = Math.random() * 2 * Math.PI;
                    const dist = 40 + Math.random() * 70;
                    const offsetX = Math.cos(angle) * dist;
                    const offsetY = Math.sin(angle) * dist * 0.6 - 15;
                    petals.push({
                        x: screenX + offsetX,
                        y: screenY + offsetY,
                        size: 14 + Math.random() * 20,
                        speedY: 1.2 + Math.random() * 4,
                        speedX: (Math.random() - 0.5) * 1.5,
                        color: `hsl(${Math.random() * 360}, 90%, 70%)`,
                        angle: Math.random() * 6.28,
                        spin: (Math.random() - 0.5) * 0.08,
                    });
                }
                if (petals.length > 700) petals.splice(0, 200);
            }

            // Ê∏∏ÊàèÁªìÊùüÊó∂ÁöÑËÉåÊôØËä±Áì£Èõ®
            function startBackgroundRain() {
                if (petalAnimationRunning) {
                    cancelAnimationFrame(petalAnimation);
                }
                petals = [];
                for (let i = 0; i < 150; i++) {
                    petals.push({
                        x: Math.random() * window.innerWidth,
                        y: Math.random() * window.innerHeight * 0.2 - 120,
                        size: 5 + Math.random() * 18,
                        speedY: 0.8 + Math.random() * 3.5,
                        speedX: (Math.random() - 0.5) * 0.6,
                        color: `hsl(${Math.random() * 60 + 300}, 80%, 70%)`,
                        angle: Math.random() * 6.28,
                        spin: (Math.random() - 0.5) * 0.03,
                    });
                }
                // ÈáçÊñ∞ÂêØÂä®Âä®ÁîªÂæ™ÁéØ
                drawPetals();
            }

            function drawPetals() {
                if (petalAnimationRunning) {
                    cancelAnimationFrame(petalAnimation);
                }
                petalAnimationRunning = true;
                
                pCtx.clearRect(0, 0, petalCanvas.width, petalCanvas.height);
                pCtx.shadowColor = 'rgba(255,180,200,0.5)';
                pCtx.shadowBlur = 10;
                for (let i = petals.length - 1; i >= 0; i--) {
                    const p = petals[i];
                    p.y += p.speedY;
                    p.x += p.speedX;
                    p.angle += p.spin;
                    if (p.y > window.innerHeight + 100) {
                        petals.splice(i, 1);
                        continue;
                    }
                    pCtx.save();
                    pCtx.translate(p.x, p.y);
                    pCtx.rotate(p.angle);
                    pCtx.fillStyle = p.color;
                    pCtx.beginPath();
                    pCtx.ellipse(0, 0, p.size*0.7, p.size*0.4, 0, 0, 2*Math.PI);
                    pCtx.fill();
                    pCtx.restore();
                }
                petalAnimation = requestAnimationFrame(drawPetals);
            }
            
            // ÂêØÂä®Ëä±Áì£Âä®Áîª
            drawPetals();

            // ÈáçÁΩÆÊ∏∏ÊàèÊ†∏ÂøÉÂáΩÊï∞Ôºà‰øùËØÅËä±Áì£Ê∏ÖÈõ∂Ôºå‰∏ÄÂàáÈáçÂêØÔºâ
            function resetGameCompletely() {
                // ÂÅúÊ≠¢Ê∏∏ÊàèÂæ™ÁéØ
                if (gameInterval) {
                    clearInterval(gameInterval);
                    gameInterval = null;
                }
                // ÂÅúÊ≠¢Èü≥‰πê
                stopBGM();
                // ÈáçÁΩÆËõá„ÄÅÊñπÂêë„ÄÅÂàÜÊï∞
                snake = [{x:10,y:10},{x:9,y:10},{x:8,y:10}];
                direction = 'RIGHT';
                nextDirection = 'RIGHT';
                score = 0;
                scoreSpan.textContent = '0';
                gameRunning = false;
                gamePaused = false;
                // ÈáçÊñ∞ÁîüÊàêÈ£üÁâ©
                generateFoods();
                // Ê∏ÖÈô§ÊâÄÊúâÈ£òËêΩËä±Áì£
                clearAllPetals();
                
                // Á°Æ‰øùËä±Áì£Âä®ÁîªÂæ™ÁéØÂú®ËøêË°å
                if (!petalAnimationRunning) {
                    drawPetals();
                }
                
                // ÈáçÁªòÊ£ãÁõò
                drawCanvas();
            }

            // Ê∏∏ÊàèÁªìÊùüÂç°Áâá
            function showGameOverCard(finalScore) {
                const old = document.querySelector('.gameover-overlay');
                if (old) old.remove();

                const overlay = document.createElement('div');
                overlay.className = 'gameover-overlay';
                overlay.innerHTML = `
                    <div class="gameover-card">
                        <h1>üå∏ LOTUS BLOOMS üå∏</h1>
                        <div class="final-score">SCORE: ${finalScore}</div>
                        <button class="restart-btn" id="restartAfterGameover">PLAY AGAIN</button>
                    </div>
                `;
                document.body.appendChild(overlay);

                document.getElementById('restartAfterGameover').addEventListener('click', () => {
                    overlay.remove();                // ÁßªÈô§Âç°Áâá
                    resetGameCompletely();            // ÂΩªÂ∫ïÈáçÁΩÆ + Ëä±Áì£Ê∏ÖÈõ∂
                });
            }

            // ÊôÆÈÄöÈáçÁΩÆ
            function resetGame() {
                resetGameCompletely();
            }

            function startGame() {
                unlockAudioForIOS().then(() => {
                    if (!muted) {
                        stopBGM();
                        playBGM();
                    }
                    
                    if (!gameRunning) {
                        gameRunning = true;
                        gamePaused = false;
                        if (gameInterval) clearInterval(gameInterval);
                        gameInterval = setInterval(step, gameSpeed);
                    } else if (gamePaused) {
                        gamePaused = false;
                        if (!muted) playBGM();
                    }
                }).catch(() => {
                    if (!muted) {
                        stopBGM();
                        playBGM();
                    }
                    
                    if (!gameRunning) {
                        gameRunning = true;
                        gamePaused = false;
                        if (gameInterval) clearInterval(gameInterval);
                        gameInterval = setInterval(step, gameSpeed);
                    } else if (gamePaused) {
                        gamePaused = false;
                    }
                });
            }

            function pauseGame() {
                if (!gameRunning) {
                    gamePaused = true;
                } else {
                    gamePaused = !gamePaused;
                    if (gamePaused) {
                        stopBGM();
                    } else {
                        if (!muted) playBGM();
                    }
                }
            }

            function step() {
                if (!gameRunning || gamePaused) return;
                
                glowPhase += glowSpeed;
                
                direction = nextDirection;
                let head = snake[0];
                let newHead = {x: head.x, y: head.y};
                if (direction === 'RIGHT') newHead.x += 1;
                else if (direction === 'LEFT') newHead.x -= 1;
                else if (direction === 'UP') newHead.y -= 1;
                else if (direction === 'DOWN') newHead.y += 1;

                if (newHead.x < 0 || newHead.x >= GRID_SIZE || newHead.y < 0 || newHead.y >= GRID_SIZE) {
                    gameOver(); return;
                }

                const eatenFoodIndex = foods.findIndex(f => f.x === newHead.x && f.y === newHead.y);
                const eating = eatenFoodIndex !== -1;
                
                let newSnake = [newHead, ...snake];
                if (!eating) newSnake.pop();

                if (newSnake.slice(1).some(s => s.x === newHead.x && s.y === newHead.y)) {
                    gameOver(); return;
                }

                snake = newSnake;

                if (eating) {
                    const eatenFood = foods[eatenFoodIndex];
                    foods.splice(eatenFoodIndex, 1);
                    
                    playWin();
                    
                    const foodCanvasX = eatenFood.x * CELL_SIZE + CELL_SIZE/2;
                    const foodCanvasY = eatenFood.y * CELL_SIZE + CELL_SIZE/2;
                    spawnTwoBlossomsAt(foodCanvasX, foodCanvasY);
                    
                    if (navigator.vibrate) navigator.vibrate(20);
                    
                    score++;
                    scoreSpan.textContent = score;
                    
                    if (foods.length === 0) {
                        if (!generateFoods()) {
                            gameOver(); 
                            return;
                        }
                    }
                }
                drawCanvas();
            }

            function gameOver() {
                if (gameInterval) { clearInterval(gameInterval); gameInterval = null; }
                gameRunning = false;
                gamePaused = false;
                stopBGM();
                playXiaochu();
                startBackgroundRain();   // Ëä±Áì£Èõ®
                showGameOverCard(score);
                drawCanvas();
            }

            // ÁªòÂõæ
            function drawCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const breathIntensity = 0.7 + 0.5 * Math.sin(glowPhase);
                
                ctx.strokeStyle = 'rgba(255, 250, 210, 0.35)';
                ctx.lineWidth = 1.5;
                for (let i = 0; i <= GRID_SIZE; i++) {
                    ctx.beginPath();
                    ctx.moveTo(i*CELL_SIZE, 0); ctx.lineTo(i*CELL_SIZE, canvas.height); ctx.stroke();
                    ctx.moveTo(0, i*CELL_SIZE); ctx.lineTo(canvas.width, i*CELL_SIZE); ctx.stroke();
                }

                foods.forEach(food => {
                    const img = foodImages[food.imageIndex];
                    const x = food.x * CELL_SIZE + CELL_SIZE/2;
                    const y = food.y * CELL_SIZE + CELL_SIZE/2;
                    
                    const baseGlow = 35;
                    const glowSize = baseGlow * breathIntensity;
                    
                    if (img && img.complete && img.naturalWidth > 0) {
                        const size = CELL_SIZE * 0.8;
                        
                        for (let i = 0; i < 3; i++) {
                            ctx.shadowBlur = glowSize + i * 8;
                            ctx.shadowColor = i === 0 ? '#ffcc00' : (i === 1 ? '#ffaa00' : '#ff8800');
                            ctx.beginPath();
                            ctx.arc(x, y, size/2 + 5, 0, 2*Math.PI);
                            ctx.fillStyle = `rgba(255, 215, 0, ${0.15 * breathIntensity})`;
                            ctx.fill();
                        }
                        
                        ctx.shadowBlur = glowSize;
                        ctx.shadowColor = '#ffdd44';
                        ctx.drawImage(img, x - size/2, y - size/2, size, size);
                        
                        ctx.shadowBlur = glowSize + 10;
                        ctx.shadowColor = '#ffaa22';
                        ctx.drawImage(img, x - size/2, y - size/2, size, size);
                        
                    } else {
                        ctx.shadowBlur = glowSize;
                        ctx.shadowColor = '#ffcc00';
                        
                        ctx.beginPath();
                        ctx.arc(x, y, CELL_SIZE/2 - 2, 0, 2*Math.PI);
                        const colors = ['#ff4d4d', '#ffaa33', '#ff66b2', '#aa66ff'];
                        ctx.fillStyle = colors[food.imageIndex % 4];
                        ctx.fill();
                        
                        ctx.shadowBlur = glowSize + 10;
                        ctx.shadowColor = '#ffaa00';
                        ctx.fill();
                    }
                    
                    ctx.shadowBlur = 0;
                    ctx.shadowColor = 'transparent';
                });

                ctx.shadowBlur = 10;
                snake.forEach((seg, idx) => {
                    const isHead = idx === 0;
                    const x = seg.x*CELL_SIZE, y = seg.y*CELL_SIZE;
                    const r = CELL_SIZE/2 - (isHead ? 2 : 4);
                    ctx.beginPath();
                    ctx.arc(x+CELL_SIZE/2, y+CELL_SIZE/2, r, 0, 2*Math.PI);
                    ctx.fillStyle = isHead ? '#f7d44a' : '#4da64d';
                    ctx.fill();
                    ctx.strokeStyle = '#1e4f1e';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    if (isHead) {
                        ctx.fillStyle = '#1e2b0e';
                        ctx.shadowBlur = 0;
                        ctx.beginPath();
                        ctx.arc(x+CELL_SIZE/2-7, y+CELL_SIZE/2-5, 3, 0, 2*Math.PI);
                        ctx.arc(x+CELL_SIZE/2+7, y+CELL_SIZE/2-5, 3, 0, 2*Math.PI);
                        ctx.fill();
                    }
                });
                ctx.shadowBlur = 0;
            }

            function animationLoop() {
                if (gameRunning && !gamePaused) {
                    drawCanvas();
                }
                requestAnimationFrame(animationLoop);
            }
            animationLoop();

            // ÈîÆÁõòËæìÂÖ•
            window.addEventListener('keydown', (e) => {
                if (e.key.startsWith('Arrow')) {
                    e.preventDefault();
                    const k = e.key.slice(5);
                    if (k === 'Up' && direction !== 'DOWN') nextDirection = 'UP';
                    else if (k === 'Down' && direction !== 'UP') nextDirection = 'DOWN';
                    else if (k === 'Left' && direction !== 'RIGHT') nextDirection = 'LEFT';
                    else if (k === 'Right' && direction !== 'LEFT') nextDirection = 'RIGHT';
                }
            });

            // Ëß¶Êë∏ÊªëÂä®
            let touchStart = null;
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const t = e.touches[0];
                touchStart = {x: t.clientX, y: t.clientY};
            }, {passive: false});
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (!touchStart) return;
                const t = e.changedTouches[0];
                const dx = t.clientX - touchStart.x;
                const dy = t.clientY - touchStart.y;
                if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 20) {
                    if (dx > 0 && direction !== 'LEFT') nextDirection = 'RIGHT';
                    else if (dx < 0 && direction !== 'RIGHT') nextDirection = 'LEFT';
                } else if (Math.abs(dy) > 20) {
                    if (dy > 0 && direction !== 'UP') nextDirection = 'DOWN';
                    else if (dy < 0 && direction !== 'DOWN') nextDirection = 'UP';
                }
                touchStart = null;
            });

            startBtn.addEventListener('click', startGame);
            pauseBtn.addEventListener('click', pauseGame);
            muteBtn.addEventListener('click', toggleMute);
            moreGames.addEventListener('click', (e) => {
                e.preventDefault();
                window.open('https://amitofoicu.github.io/home/main.html', '_blank');
            });

            function resizePetal() {
                petalCanvas.width = window.innerWidth;
                petalCanvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizePetal);
            resizePetal();

            // ÂàùÂßãÈáçÁΩÆ
            resetGame();

            document.body.addEventListener('touchstart', function unlockOnTouch() {
                unlockAudioForIOS();
                document.body.removeEventListener('touchstart', unlockOnTouch);
            }, {passive: true});
        })();
    </script>
</body>
</html>